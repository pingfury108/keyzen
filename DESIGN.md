# Keyzen 设计文档

> 基于 Rust + GPUI 的跨平台打字练习软件完整设计方案

---

## 📋 目录

- [一、项目概述](#一项目概述)
- [二、设计理念](#二设计理念)
- [三、视觉设计系统](#三视觉设计系统)
- [四、架构设计](#四架构设计)
- [五、交互设计](#五交互设计)
- [六、功能模块设计](#六功能模块设计)
- [七、数据设计](#七数据设计)
- [八、性能设计](#八性能设计)
- [九、可扩展性设计](#九可扩展性设计)
- [十、实施路线图](#十实施路线图)

---

## 一、项目概述

### 1.1 项目定位

**Keyzen（键禅）** 是一款专注于**心流体验**的现代化打字练习软件，利用 Rust 的高性能特性和 GPUI 的极致渲染能力，为用户提供**零干扰、流畅如丝**的打字练习环境。

### 1.2 核心价值主张

| 维度 | 价值 |
|------|------|
| **体验** | 进入"禅"的状态 - 极简、专注、心流 |
| **性能** | 120FPS+ 渲染，零延迟反馈 |
| **包容** | 支持中文（含拼音）、英文、代码等多语言 |
| **科学** | 数据驱动的进步追踪与个性化推荐 |

### 1.3 目标用户

- **开发者**：需要提升代码输入速度和特殊符号熟练度
- **中文用户**：想要系统性练习拼音输入或提升中文打字速度
- **效率追求者**：希望通过科学训练提升工作效率
- **键盘爱好者**：享受流畅打字体验的极客

---

## 二、设计理念

### 2.1 核心设计原则

#### 🧘 禅意心流 (Zen Flow)

> "最好的界面是没有界面"

**设计哲学**：
- **极简主义**：移除一切非必要元素，让用户完全沉浸于文本本身
- **零干扰**：统计信息默认隐藏，仅在需要时优雅展现
- **留白艺术**：借鉴东方美学，通过负空间引导注意力聚焦

**实践**：
- 核心练习区占据屏幕中央 70% 空间
- 统计信息以半透明形式存在，心流模式下完全隐藏
- 配置界面采用模态覆盖，不破坏主界面的连续性

#### ⚡ 极致性能 (Velocity)

> "延迟即打断，流畅即心流"

**设计哲学**：
- **瞬时反馈**：每次按键必须在 16ms 内得到视觉响应
- **丝滑动画**：利用 GPUI 的 GPU 加速，实现 120FPS+ 的平滑过渡
- **无感计算**：统计计算在后台线程完成，渲染线程专注于绘制

**实践**：
- 光标移动采用贝塞尔曲线插值，而非瞬移
- 错误反馈通过微弱的颜色渐变，而非闪烁
- WPM 数值更新采用计数动画，而非跳变

#### 🌍 跨越语言 (Polyglot)

> "语言不应成为练习的障碍"

**设计哲学**：
- **文化感知**：针对不同语言特性定制体验（如中文分词、代码高亮）
- **统一体验**：所有语言共享相同的视觉语言和交互模式
- **可扩展性**：语言模块插件化，社区可贡献新语言支持

**实践**：
- 中文模式支持拼音输入练习和汉字输出练习
- 代码模式提供语法高亮和常用符号聚焦训练
- 多语言课程通过统一的数据格式管理

#### 👁️ 视觉舒适 (Clarity)

> "长时间使用不应感到疲劳"

**设计哲学**：
- **护眼优先**：默认深色模式，采用科学的色彩对比度
- **排版考究**：使用等宽字体，确保中英文字符对齐
- **柔和反馈**：错误提示使用暖色调，而非刺眼的红色

**实践**：
- 背景色 #1A1A1A（极深灰）减少屏幕亮度
- 文字色 #F0F0F0（亮白）提供最佳可读性
- 错误色 #FF9966（暖橘红）温和提示而不引发焦虑

---

### 2.2 品牌视觉语言

#### Logo 设计

**方案：心流按键 (Flowing Key)**

**核心元素**：
1. **深色圆角矩形** - 代表键盘按键的物理形态，传达稳定感
2. **电光蓝流线** - 象征指尖在键盘上的舞动轨迹，体现心流状态
3. **抽象的 K/Z 字母** - 通过流线的路径暗示 Keyzen 的首字母

**设计特点**：
- 流线采用贝塞尔曲线，起点和终点略微"溢出"按键本体，增强动感
- 电光蓝（#00C2B8）自带微弱发光效果，呼应 Logo 的科技感
- 整体构图遵循黄金比例，视觉重心偏下，给人稳定而向前的感受

**应用场景**：
- 应用图标（1024x1024, 512x512, 256x256）
- 启动画面（Logo + 品牌口号）
- 设置界面的导航按钮
- 课程完成后的成就徽章

#### 品牌口号

- **中文**：键起，心流生
- **英文**：Type with Flow
- **理念**：按下第一个键的瞬间，心流状态即刻开始

---

## 三、视觉设计系统

### 3.1 色彩系统

#### 主色板 (Primary Palette)

| 颜色名称 | HEX | RGB | 用途 |
|----------|-----|-----|------|
| **深沉黑** | `#1A1A1A` | `(26, 26, 26)` | 主背景 |
| **碳灰** | `#2A2A2A` | `(42, 42, 42)` | 次级背景、按键本体 |
| **亮白** | `#F0F0F0` | `(240, 240, 240)` | 主文本、已输入正确文字 |
| **中灰** | `#A0A0A0` | `(160, 160, 160)` | 待输入文本、次要信息 |
| **电光蓝** | `#00C2B8` | `(0, 194, 184)` | 高光、光标、Logo 流线 |
| **青绿** | `#33CCFF` | `(51, 204, 255)` | 交互元素、进度条 |

#### 语义色板 (Semantic Palette)

| 语义 | 颜色 | HEX | 应用场景 |
|------|------|-----|----------|
| **正确** | 亮白 | `#F0F0F0` | 正确输入的字符 |
| **错误** | 暖橘红 | `#FF9966` | 错误字符下划线、轻微背景色 |
| **当前** | 电光蓝 | `#00C2B8` | 当前应输入字符的高光 |
| **完成** | 青绿 | `#33CCFF` | 进度条、完成动画 |
| **警告** | 琥珀黄 | `#FFB84D` | 速度过快提示（防止盲打错误累积） |

#### 色彩使用原则

1. **对比度要求**：
   - 正文与背景对比度 ≥ 7:1（符合 WCAG AAA 标准）
   - 次要文本与背景对比度 ≥ 4.5:1

2. **错误反馈策略**：
   - **禁止**：大面积红色背景、闪烁动画
   - **推荐**：字符下方细线（1px）+ 背景色微弱变化（透明度 10%）

3. **渐变使用**：
   - 仅在 Logo、启动画面、完成动画中使用渐变
   - 核心练习区避免渐变，保持纯色以减少视觉疲劳

---

### 3.2 字体系统

#### 核心练习区字体

**要求**：
- 必须是**等宽字体** (Monospace)
- 支持 **CJK 字符**（中日韩统一表意文字）
- 具备良好的**字符区分度**（如 `1Il0O` 清晰可辨）

**推荐字体**：

| 字体名称 | 优势 | 适用场景 |
|----------|------|----------|
| **JetBrains Mono** | 专为开发者设计，连字美观 | 代码模式 |
| **Fira Code** | 连字丰富，符号清晰 | 代码模式 |
| **Sarasa Gothic** (更纱黑体) | CJK 支持优秀，等宽精准 | 中文模式 |
| **Cascadia Code** | Microsoft 开发，Windows 原生体验好 | 通用 |

**字体规格**：
```
字号：24px（核心练习区）
行高：1.6（40px）
字重：Regular (400)
字间距：0（等宽字体无需调整）
```

#### UI 界面字体

**系统默认无衬线字体**：
- macOS: San Francisco
- Windows: Segoe UI
- Linux: Roboto / Noto Sans

**字体规格**：
```
大标题：20px / Medium (500)
小标题：16px / Medium (500)
正文：14px / Regular (400)
说明文字：12px / Regular (400)
```

---

### 3.3 布局系统

#### 三段式布局结构

```
┌─────────────────────────────────────────┐
│  [Logo]           统计信息区              │  ← 顶部栏（可隐藏）
│                  (非侵入式)               │     高度：60px
├─────────────────────────────────────────┤
│                                         │
│                                         │
│                                         │
│           核心练习区                      │  ← 主体区
│         (绝对居中聚焦)                    │     占据 70% 垂直空间
│                                         │
│                                         │
│                                         │
├─────────────────────────────────────────┤
│         [进度条]  [快捷键提示]            │  ← 底部栏（可选）
└─────────────────────────────────────────┘     高度：40px
```

#### 核心练习区设计细节

**文本容器**：
- 最大宽度：`800px`（约 60 个英文字符）
- 内边距：`48px`（上下左右）
- 水平居中：`margin: 0 auto`

**文本行设计**：
```
┌──────────────────────────────────────┐
│  待输入文本（中灰 #A0A0A0）           │
│  ▓▓▓▓▓▓ 已输入（亮白 #F0F0F0）        │  ← 当前行
│  █ 光标（电光蓝，呼吸动画）            │
│                                      │
│  下一行文本预览（透明度 50%）          │  ← 预览行
└──────────────────────────────────────┘
```

**可见范围控制**：
- 同时显示：当前行 + 上 1 行 + 下 2 行
- 滚动触发：光标到达可见区域底部时平滑滚动
- 虚拟渲染：长文本仅渲染可见部分 + 缓冲区（上下各 5 行）

#### 统计信息区布局

**Zen 模式（默认）**：
```
WPM: 72  |  准确率: 98.5%  |  进度: 45%
```
- 字号：14px
- 透明度：70%
- 悬停时：100% + 展开详细数据

**完成后展开**：
```
┌─────────────────────────────────────┐
│        🎉 课程完成！                 │
│                                     │
│  最终速度：  82 WPM                  │
│  准确率：    96.2%                   │
│  用时：      3分42秒                 │
│  薄弱按键：  { } [ ] < >             │
│                                     │
│  [查看详情]  [重新练习]  [下一课]    │
└─────────────────────────────────────┘
```

---

### 3.4 动画系统

#### 核心设计原则

1. **速度感知**：所有动画时长 ≤ 400ms
2. **缓动曲线**：使用 `ease-out` 系列，给人"加速-减速"的自然感
3. **性能优先**：仅使用 GPU 加速的属性（transform, opacity）

#### 关键动画定义

| 动画名称 | 时长 | 缓动函数 | 触发时机 |
|----------|------|----------|----------|
| **光标呼吸** | 530ms | ease-in-out | 循环播放 |
| **光标移动** | 150ms | ease-out | 输入正确字符 |
| **错误闪烁** | 200ms | ease-out | 输入错误字符 |
| **涟漪扩散** | 400ms | ease-out + fade | 输入正确字符（可选） |
| **统计更新** | 300ms | ease-out | WPM 数值变化 |
| **完成弹窗** | 500ms | spring (弹性) | 课程完成 |

#### 光标设计

**形态**：竖线（宽度 2px，高度与文字同高）

**呼吸动画**：
```
透明度变化：100% → 0% → 100%
周期：530ms（黄金比例相关）
缓动：cubic-bezier(0.4, 0, 0.6, 1)
```

**移动动画**：
```
位置变化：当前位置 → 下一位置
时长：150ms
轨迹：贝塞尔曲线插值（模拟手指滑动）
```

#### 涟漪效果（可选特效）

**触发条件**：输入正确字符时

**视觉表现**：
- 从字符中心扩散的圆形光晕
- 颜色：电光蓝 (#00C2B8)
- 初始透明度：30%
- 结束透明度：0%
- 半径变化：0 → 40px
- 时长：400ms

**性能考量**：
- 使用 CSS `transform: scale()` 而非 `width/height`
- 限制同时存在的涟漪数量（最多 3 个）
- 低性能设备自动禁用

---

## 四、架构设计

### 4.1 整体架构图

```
┌─────────────────────────────────────────────────────┐
│                   Keyzen Application                 │
└─────────────────────────────────────────────────────┘
                          │
        ┌─────────────────┼─────────────────┐
        │                 │                 │
        ▼                 ▼                 ▼
┌──────────────┐  ┌──────────────┐  ┌──────────────┐
│  keyzen_ui   │  │ keyzen_cli   │  │ keyzen_wasm  │  ← 表现层
│   (GPUI)     │  │  (终端版)     │  │   (Web版)    │
└──────────────┘  └──────────────┘  └──────────────┘
        │                 │                 │
        └─────────────────┼─────────────────┘
                          │
                          ▼
              ┌──────────────────────┐
              │   keyzen_engine      │  ← 业务逻辑层
              │  (核心打字引擎)       │
              └──────────────────────┘
                          │
        ┌─────────────────┼─────────────────┐
        │                 │                 │
        ▼                 ▼                 ▼
┌──────────────┐  ┌──────────────┐  ┌──────────────┐
│ keyzen_data  │  │keyzen_persist│  │ keyzen_core  │  ← 基础设施层
│ (课程加载)    │  │ (数据持久化)  │  │ (类型定义)    │
└──────────────┘  └──────────────┘  └──────────────┘
```

### 4.2 分层职责

#### Layer 1: 基础设施层 (Foundation)

**keyzen_core - 核心类型定义**

| 职责 | 包含内容 |
|------|----------|
| 类型定义 | Lesson, LessonType, Difficulty, InputMode |
| 事件定义 | TypingEvent 枚举（按键事件、完成事件等） |
| 统计数据 | SessionStats 结构体 |
| 共享常量 | 默认配置值、版本号 |

**设计原则**：
- 零依赖（仅依赖 serde）
- 所有类型必须可序列化
- 不包含任何业务逻辑

---

**keyzen_data - 数据管理**

| 职责 | 包含内容 |
|------|----------|
| 课程加载 | 从文件系统加载 RON/YAML 格式的课程 |
| 内容过滤 | 按语言、难度、标签筛选课程 |
| 热重载 | 开发模式下监听文件变化 |
| 缓存管理 | 课程内容的内存缓存 |

**数据格式选择**：**RON (Rusty Object Notation)**

**理由**：
1. Rust 原生语法，开发者友好
2. 支持复杂嵌套结构（如元数据、前置课程关系）
3. 类型安全，编译期检查
4. 可读性优于 JSON，简洁性优于 YAML

**示例课程文件**：
```ron
Lesson(
    id: 1,
    lesson_type: Pinyin,
    language: "zh-CN",
    title: "拼音基础 - 声母练习",
    description: "练习常用声母组合",
    source_text: "ba bo bi bu\nma mo mi mu",
    meta: LessonMeta(
        difficulty: Beginner,
        tags: ["拼音", "声母"],
        estimated_time: (secs: 120, nanos: 0),
        prerequisite_ids: [],
    ),
)
```

---

**keyzen_persistence - 持久化**

| 职责 | 包含内容 |
|------|----------|
| 历史记录 | 保存每次练习的统计数据 |
| 进度追踪 | 记录已完成课程、最佳成绩 |
| 分析引擎 | 计算用户薄弱按键、进步曲线 |
| 数据导出 | 支持导出为 CSV/JSON 格式 |

**存储方案**：**SQLite**

**理由**：
1. 轻量级，无需独立数据库服务
2. 本地优先，保护用户隐私
3. 事务支持，数据安全性高
4. 跨平台兼容性好

**数据库表设计**：

```sql
-- 练习会话表
CREATE TABLE sessions (
    id INTEGER PRIMARY KEY,
    lesson_id INTEGER NOT NULL,
    wpm REAL NOT NULL,
    cpm REAL NOT NULL,
    accuracy REAL NOT NULL,
    total_keystrokes INTEGER NOT NULL,
    error_count INTEGER NOT NULL,
    duration_secs INTEGER NOT NULL,
    timestamp INTEGER NOT NULL,
    mode TEXT NOT NULL  -- "Zen", "Timed", "Endless"
);

-- 薄弱按键表
CREATE TABLE weak_keys (
    session_id INTEGER NOT NULL,
    char TEXT NOT NULL,
    error_rate REAL NOT NULL,
    FOREIGN KEY(session_id) REFERENCES sessions(id)
);

-- 课程进度表
CREATE TABLE course_progress (
    lesson_id INTEGER PRIMARY KEY,
    completed_count INTEGER DEFAULT 0,
    best_wpm REAL,
    best_accuracy REAL,
    first_completed_at INTEGER,
    last_practiced_at INTEGER
);
```

---

#### Layer 2: 业务逻辑层 (Business Logic)

**keyzen_engine - 核心引擎**

这是 Keyzen 的"大脑"，负责所有业务逻辑，与 UI 完全解耦。

| 模块 | 职责 |
|------|------|
| **TypingSession** | 管理单次打字会话状态 |
| **StatisticsCalculator** | 实时计算 WPM、准确率、进步曲线 |
| **InputValidator** | 验证用户输入，判断正确/错误 |
| **PinyinProcessor** | 处理中文拼音输入逻辑 |
| **EventPublisher** | 发布事件供 UI 订阅 |

**核心设计模式**：**事件驱动架构**

**工作流程**：
```
用户按键 → InputValidator 验证
         → TypingSession 更新状态
         → StatisticsCalculator 计算数据
         → EventPublisher 发布事件
         → UI 订阅事件并更新视图
```

**事件类型定义**：
```rust
pub enum TypingEvent {
    KeyPressed {
        char: char,
        correct: bool,
        position: usize
    },
    WordCompleted {
        wpm: f64
    },
    MilestoneReached {
        progress: f32  // 0.0 - 1.0
    },
    SessionCompleted {
        stats: SessionStats
    },
    ErrorCorrected {
        position: usize
    },
}
```

**优势**：
- UI 只需订阅事件，无需主动轮询状态
- 支持多种反馈形式（音效、震动、粒子效果）
- 便于调试和日志记录

---

**输入模式设计**

**决策：默认采用 Forgiving 模式**

| 模式 | 行为 | 适用场景 |
|------|------|----------|
| **Strict（严格）** | 必须删除错误才能继续 | 考试模式、精准度训练 |
| **Forgiving（宽容）** | 标记错误但可继续 | 日常练习、保持心流（**默认**） |
| **Invisible（隐形）** | 不显示错误提示 | 盲打训练、高级用户 |

**理由选择 Forgiving**：
1. **降低挫败感**：初学者不会因频繁删除而中断心流
2. **真实场景模拟**：日常打字时不会为每个错别字停下来
3. **数据收集**：保留错误记录，用于分析薄弱环节
4. **用户可选**：高级用户可切换到 Strict 模式

---

**中文拼音处理设计**

**两种练习模式**：

1. **拼音输入练习**：
   - 目标文本：`ni hao ma`
   - 用户输入：逐字母输入拼音
   - 验证逻辑：与目标拼音字符串逐字符比对
   - 用途：熟悉拼音拼写规则

2. **汉字输出练习**：
   - 目标文本：`你好吗`
   - 用户输入：通过拼音输入法输入汉字
   - 验证逻辑：比对最终输出的汉字
   - 用途：提升中文输入速度

**拼音状态管理**：
```rust
pub struct PinyinState {
    pub buffer: String,           // 当前拼音缓冲："ni"
    pub candidates: Vec<char>,    // 候选字：['你', '泥', '尼']
    pub composing: bool,          // 是否在组字状态
}
```

**候选字选择逻辑**：
- 空格键：确认第一个候选字
- 数字键 1-9：选择对应序号的候选字
- Backspace：删除拼音缓冲中的最后一个字母

**技术实现**：
- 使用 `pinyin` crate 进行拼音到汉字的映射
- 预加载常用词库（约 10,000 个高频词）
- 支持模糊音（如 z/zh, c/ch, s/sh）

---

#### Layer 3: 表现层 (Presentation)

**keyzen_ui - GPUI 渲染层**

| 模块 | 职责 |
|------|------|
| **TypingView** | 核心练习区组件 |
| **StatsView** | 统计信息显示组件 |
| **SettingsPanel** | 配置界面 |
| **ThemeManager** | 主题加载与切换 |
| **AnimationEngine** | 动画系统管理 |

**职责边界**：
- ✅ **应该做**：接收 Engine 状态快照，渲染视图，处理用户输入事件
- ❌ **不应该做**：计算 WPM、验证输入正确性、管理业务状态

**状态快照设计**：
```rust
pub struct SessionSnapshot {
    pub visible_range: Range<usize>,  // 当前可见文本范围
    pub cursor_position: usize,       // 光标位置
    pub recent_errors: Vec<usize>,    // 最近错误位置（仅保留可见区域）
    pub current_wpm: f64,             // 当前 WPM
    pub accuracy: f64,                // 当前准确率
    pub progress: f32,                // 进度百分比
}
```

**为什么是快照而非完整状态**：
1. **性能优化**：避免克隆大对象（如完整的输入历史）
2. **按需渲染**：仅包含 UI 需要的最小数据集
3. **解耦**：UI 不关心引擎的内部实现细节

---

### 4.3 数据流设计

#### 完整数据流图

```
┌─────────────┐
│   用户按键   │
└──────┬──────┘
       │
       ▼
┌─────────────────────────────────────┐
│  keyzen_ui (GPUI Event Handler)     │
│  - 捕获 KeyDown 事件                 │
│  - 提取字符并传递给 Engine           │
└──────┬──────────────────────────────┘
       │
       ▼
┌─────────────────────────────────────┐
│  keyzen_engine (TypingSession)      │
│  - 验证输入正确性                    │
│  - 更新内部状态                      │
│  - 计算实时统计                      │
│  - 发布 TypingEvent                 │
└──────┬──────────────────────────────┘
       │
       ├──────────────┬─────────────────┐
       │              │                 │
       ▼              ▼                 ▼
┌──────────┐   ┌──────────┐   ┌──────────────┐
│ UI 订阅  │   │ 音效模块 │   │ 持久化模块    │
│ 更新视图 │   │ 播放反馈 │   │ 保存统计数据  │
└──────────┘   └──────────┘   └──────────────┘
```

#### 关键设计决策

**1. 为什么使用事件而非轮询？**

| 方式 | 优点 | 缺点 |
|------|------|------|
| **轮询** | 实现简单 | 性能浪费、状态不一致 |
| **事件驱动** | 按需更新、解耦良好 | 需要管理订阅关系 |

**结论**：采用事件驱动，通过 `std::sync::mpsc` 实现发布-订阅。

**2. 引擎计算在哪个线程？**

**决策**：统计计算在**后台线程**，UI 渲染在**主线程**

**实现**：
```
主线程 (UI Rendering)
    ↑
    │ 快照数据
    │
后台线程 (Engine Calculation)
    ← 用户输入事件
```

**优势**：
- 复杂的 WPM 计算不阻塞渲染
- 保证 GPUI 始终运行在 120FPS

---

## 五、交互设计

### 5.1 按键交互逻辑

#### 核心原则

**即时反馈 + 柔和提示 + 保持心流**

#### 正确输入流程

```
用户按键 → 字符高亮为亮白色 (#F0F0F0)
         → 光标平滑移动到下一个字符（150ms 贝塞尔曲线）
         → （可选）涟漪效果扩散（400ms）
         → WPM 数值平滑更新（300ms 计数动画）
```

#### 错误输入流程（Forgiving 模式）

```
用户按键 → 字符下方出现橘红细线（#FF9966, 1px）
         → 背景色微弱变化（透明度 10%，持续 200ms）
         → 光标继续移动（不阻断）
         → 错误计数 +1
```

**视觉对比**：
```
正确： The quick brown fox
       ^^^^^^^^^^^^^^^^^^^

错误： The qiuck brown fox
           _____
          （细线提示，不刺眼）
```

#### 删除交互 (Backspace)

**行为**：
- 光标回退一个字符
- 删除已输入的字符
- 如果删除的是错误字符，移除错误标记并发送 `ErrorCorrected` 事件

**限制**：
- 不允许删除超过当前已输入的部分
- Strict 模式下，必须删除错误字符才能继续

---

### 5.2 模式切换交互

#### Zen 模式（默认）

**特点**：
- 无时间限制
- 统计信息半透明显示
- 按 `Esc` 可暂停并显示菜单

**适用场景**：日常练习、学习新课程

#### Timed 模式（限时挑战）

**特点**：
- 倒计时显示在顶部（如 60 秒）
- 时间耗尽自动结束并显示结果
- 强调速度优先

**适用场景**：竞速比赛、自我挑战

#### Endless 模式（无限练习）

**特点**：
- 随机生成文本内容（基于词库）
- 无固定终点，可随时退出
- 适合热身和保持手感

**适用场景**：热身、放松练习

---

### 5.3 课程导航交互

#### 课程选择界面

**布局**：
```
┌────────────────────────────────────────┐
│  筛选栏                                 │
│  [全部] [中文] [英文] [代码]            │
│  [初级] [中级] [高级]                   │
├────────────────────────────────────────┤
│  课程列表                               │
│  ┌──────────────────────────────────┐  │
│  │ 📘 拼音基础 - 声母练习           │  │
│  │    难度: ⭐ | 预估: 2分钟         │  │
│  │    最佳: 82 WPM | 上次: 昨天      │  │
│  └──────────────────────────────────┘  │
│  ┌──────────────────────────────────┐  │
│  │ 💻 Rust 函数定义                 │  │
│  │    难度: ⭐⭐ | 预估: 5分钟       │  │
│  │    最佳: 未完成                   │  │
│  └──────────────────────────────────┘  │
└────────────────────────────────────────┘
```

**交互**：
- 鼠标悬停：卡片高亮 + 显示预览文本
- 点击：进入课程
- 右键：显示选项（重置进度、查看历史）

#### 课程完成交互

**动画流程**：
```
1. 最后一个字符输入完成
   ↓
2. 文本渐隐（300ms）
   ↓
3. 完成弹窗从中心弹出（500ms 弹性动画）
   ↓
4. 统计数据逐项淡入（每项间隔 100ms）
   ↓
5. 显示操作按钮
```

**弹窗内容**：
```
┌─────────────────────────────────┐
│       🎉 课程完成！              │
│                                 │
│  最终速度：  82 WPM  (↑12%)     │
│  准确率：    96.2%              │
│  用时：      3分42秒            │
│  薄弱按键：  { } [ ] < >        │
│                                 │
│  [查看详情]  [重练]  [下一课]   │
└─────────────────────────────────┘
```

---

### 5.4 快捷键设计

| 快捷键 | 功能 | 说明 |
|--------|------|------|
| `Esc` | 暂停/返回 | 显示菜单或返回课程列表 |
| `Cmd/Ctrl + ,` | 打开设置 | 模态窗口覆盖 |
| `Cmd/Ctrl + R` | 重新开始 | 重置当前课程进度 |
| `Cmd/Ctrl + H` | 切换统计显示 | 显示/隐藏统计栏 |
| `Cmd/Ctrl + T` | 切换主题 | 深色/浅色模式 |
| `F11` | 全屏模式 | 沉浸式练习 |

---

## 六、功能模块设计

### 6.1 统计分析模块

#### 实时统计

**WPM (Words Per Minute) 计算**

**标准公式**：
```
WPM = (正确字符数 / 5) / (时间/60)
```

**实时计算策略**：
- 维护一个 10 秒滑动窗口
- 仅统计窗口内的正确字符
- 每次按键后重新计算

**为什么是 10 秒窗口**：
1. 足够反映当前速度
2. 不会因早期错误拖累整体
3. 符合人类感知的"实时"概念

---

**准确率 (Accuracy) 计算**

**公式**：
```
准确率 = 正确按键数 / 总按键数
```

**显示策略**：
- 实时显示：当前准确率
- 完成后显示：整体准确率

---

**CPM (Characters Per Minute)**

**计算**：
```
CPM = 正确字符数 / (时间/60)
```

**用途**：
- 作为 WPM 的补充指标
- 对于中文等非英文语言更有意义

---

#### 历史分析

**进步曲线**

**数据维度**：
- X 轴：练习日期
- Y 轴：WPM
- 数据点：每次练习的最佳成绩

**可视化形式**：
```
WPM
100 ┤                           ●
 90 ┤                     ●   ╱
 80 ┤               ●   ╱
 70 ┤         ●   ╱
 60 ┤   ●   ╱
 50 ┤ ●
    └─────────────────────────────→
     1/1  1/8  1/15 1/22 1/29  日期
```

**薄弱按键分析**

**识别逻辑**：
1. 统计每个字符的出现次数和错误次数
2. 计算错误率 = 错误次数 / 出现次数
3. 筛选：出现次数 ≥ 3 且错误率 > 20%
4. 排序：按错误率降序
5. 取前 5 个

**展示形式**：
```
您的薄弱按键：
{ → 错误率 45%  ████████████
} → 错误率 38%  ██████████
[ → 错误率 32%  ████████
< → 错误率 28%  ███████
> → 错误率 25%  ██████
```

**个性化建议**：
- 推荐专门针对这些字符的练习课程
- 生成随机文本时增加这些字符的出现频率

---

### 6.2 课程推荐模块

#### 推荐策略

**1. 基于难度的渐进推荐**

**逻辑**：
```
IF 当前课程 WPM ≥ 目标 WPM * 0.9 AND 准确率 ≥ 95%
THEN 推荐下一难度级别的课程
ELSE 推荐同难度的其他课程
```

**2. 基于薄弱环节的针对性推荐**

**逻辑**：
```
分析用户薄弱按键 → 查找包含这些字符的课程 → 按匹配度排序
```

**示例**：
```
检测到您对 {} [] 符号不熟练
推荐课程：
- Rust 结构体定义
- JSON 格式练习
- 数组与切片语法
```

**3. 基于兴趣标签的推荐**

**逻辑**：
```
统计用户完成课程的标签分布 → 推荐相同标签的未完成课程
```

---

### 6.3 主题系统

#### 预设主题

| 主题名称 | 背景色 | 文本色 | 高光色 | 适用场景 |
|----------|--------|--------|--------|----------|
| **Keyzen Dark** | #1A1A1A | #F0F0F0 | #00C2B8 | 默认（护眼） |
| **Keyzen Light** | #FAFAFA | #2A2A2A | #0080FF | 白天使用 |
| **Solarized Dark** | #002B36 | #839496 | #268BD2 | 经典配色 |
| **Dracula** | #282A36 | #F8F8F2 | #FF79C6 | 流行选择 |
| **Nord** | #2E3440 | #ECEFF4 | #88C0D0 | 冷色调 |

#### 自定义主题

**配置文件格式（RON）**：
```ron
Theme(
    name: "My Custom Theme",
    colors: ColorScheme(
        background: 0x1A1A1A,
        primary_text: 0xF0F0F0,
        secondary_text: 0xA0A0A0,
        accent: 0x00C2B8,
        error: 0xFF9966,
        cursor: 0x33CCFF,
    ),
    typography: Typography(
        editor_font: "JetBrains Mono",
        editor_size: 24.0,
        ui_font: "San Francisco",
        ui_size: 14.0,
    ),
    animation: AnimationConfig(
        cursor_blink_speed_ms: 530,
        error_flash_duration_ms: 200,
    ),
)
```

**加载路径**：
- macOS: `~/Library/Application Support/Keyzen/themes/`
- Linux: `~/.config/keyzen/themes/`
- Windows: `%APPDATA%\Keyzen\themes\`

---

### 6.4 音效系统（可选）

#### 音效类型

| 音效 | 触发时机 | 音频特征 |
|------|----------|----------|
| **按键音** | 每次正确输入 | 短促、清脆（50ms） |
| **错误音** | 错误输入 | 柔和、低沉（100ms） |
| **完成音** | 课程完成 | 悠扬、愉悦（500ms） |
| **里程碑音** | 达成目标 | 鼓舞、激励（300ms） |

#### 音效库选择

**推荐**：Mechanical Keyboard Sound Pack

**来源**：
- Cherry MX Blue（清脆响亮）
- Topre（柔和安静）
- Gateron Brown（中性平衡）

**实现**：
- 使用 `rodio` crate 播放音频
- 异步播放，不阻塞主线程
- 支持音量调节和开关

---

## 七、数据设计

### 7.1 课程数据结构

#### 核心字段

```rust
pub struct Lesson {
    pub id: u32,                    // 唯一标识
    pub lesson_type: LessonType,    // Prose/Code/Pinyin/SpecialChars
    pub language: String,           // "zh-CN", "en-US", "rust"
    pub title: String,              // "拼音基础 - 声母练习"
    pub description: String,        // 课程简介
    pub source_text: String,        // 原始文本内容
    pub meta: LessonMeta,           // 元数据
}

pub struct LessonMeta {
    pub difficulty: Difficulty,     // Beginner/Intermediate/Advanced
    pub tags: Vec<String>,          // ["拼音", "声母", "基础"]
    pub estimated_time: Duration,   // 预估完成时间
    pub prerequisite_ids: Vec<u32>, // 前置课程 ID
}
```

#### 课程组织策略

**目录结构**：
```
lessons/
├── chinese/
│   ├── pinyin/
│   │   ├── 01_shengmu.ron       # 声母练习
│   │   ├── 02_yunmu.ron         # 韵母练习
│   │   └── 03_shengyun.ron      # 声韵组合
│   └── hanzi/
│       ├── 01_common_chars.ron  # 常用汉字
│       └── 02_idioms.ron        # 成语练习
├── english/
│   ├── beginner/
│   │   └── 01_alphabet.ron      # 字母练习
│   ├── intermediate/
│   │   └── 01_common_words.ron  # 常用词汇
│   └── advanced/
│       └── 01_articles.ron      # 文章练习
├── code/
│   ├── rust/
│   │   ├── 01_functions.ron     # 函数定义
│   │   ├── 02_structs.ron       # 结构体
│   │   └── 03_traits.ron        # Trait 语法
│   ├── python/
│   └── javascript/
└── special/
    ├── symbols.ron               # 特殊符号
    └── numbers.ron               # 数字练习
```

#### 课程内容示例

**中文拼音课程**：
```ron
Lesson(
    id: 1,
    lesson_type: Pinyin,
    language: "zh-CN",
    title: "拼音基础 - 声母练习",
    description: "通过常用音节组合，熟悉 21 个声母的拼写规则",
    source_text: "ba bo bi bu\npa po pi pu\nma mo mi mu\nfa fo\nda de di du\nta te ti tu\nna ne ni nu\nla le li lu\nga ge gu\nka ke ku\nha he hu\nji qi xi\nzhi chi shi ri\nzi ci si\nzha zhe zhu\ncha che chu\nsha she shu",
    meta: LessonMeta(
        difficulty: Beginner,
        tags: ["拼音", "声母", "基础"],
        estimated_time: (secs: 180, nanos: 0),
        prerequisite_ids: [],
    ),
)
```

**Rust 代码课程**：
```ron
Lesson(
    id: 101,
    lesson_type: Code,
    language: "rust",
    title: "Rust 函数定义",
    description: "练习 Rust 函数语法、参数传递和返回值",
    source_text: "fn add(a: i32, b: i32) -> i32 {\n    a + b\n}\n\nfn main() {\n    let result = add(5, 3);\n    println!(\"Result: {}\", result);\n}",
    meta: LessonMeta(
        difficulty: Intermediate,
        tags: ["rust", "function", "syntax"],
        estimated_time: (secs: 300, nanos: 0),
        prerequisite_ids: [100],  // 前置：Rust 基础语法
    ),
)
```

---

### 7.2 统计数据结构

#### 会话统计

```rust
pub struct SessionStats {
    pub lesson_id: u32,
    pub wpm: f64,                   // Words Per Minute
    pub cpm: f64,                   // Characters Per Minute
    pub accuracy: f64,              // 0.0 - 1.0
    pub total_keystrokes: usize,    // 总按键数
    pub error_count: usize,         // 错误次数
    pub duration: Duration,         // 练习时长
    pub timestamp: i64,             // Unix 时间戳
    pub weak_keys: Vec<(char, f32)>,// 薄弱按键及其错误率
}
```

#### 全局进度

```rust
pub struct UserProgress {
    pub total_lessons_completed: usize,
    pub total_practice_time: Duration,
    pub best_wpm: f64,
    pub average_accuracy: f64,
    pub current_streak: u32,        // 连续练习天数
    pub last_practiced_at: i64,
}
```

---

### 7.3 配置数据结构

#### 用户偏好

```ron
UserConfig(
    theme: "Keyzen Dark",
    editor_font: "JetBrains Mono",
    font_size: 24.0,
    show_stats: true,
    sound_enabled: false,
    input_mode: Forgiving,
    practice_mode: Zen,
    animation_speed: Normal,        // Slow/Normal/Fast/Off
)
```

**存储位置**：
- macOS: `~/Library/Application Support/Keyzen/config.ron`
- Linux: `~/.config/keyzen/config.ron`
- Windows: `%APPDATA%\Keyzen\config.ron`

---

## 八、性能设计

### 8.1 渲染性能

#### 目标指标

| 指标 | 目标值 | 说明 |
|------|--------|------|
| **帧率** | 120 FPS | 利用 GPUI 的 GPU 加速 |
| **输入延迟** | < 16ms | 从按键到视觉反馈的时间 |
| **内存占用** | < 100MB | 空闲状态下的内存使用 |
| **启动时间** | < 1s | 从点击到可用的时间 |

#### 优化策略

**1. 虚拟渲染**

**原理**：仅渲染可见区域 + 缓冲区

**实现**：
```
总文本：1000 行
可见区域：第 45-50 行（共 6 行）
渲染范围：第 40-55 行（共 16 行）
         ↑
     缓冲 5 行（上）+ 可见 6 行 + 缓冲 5 行（下）
```

**优势**：
- 长文本课程（如整篇文章）不会影响性能
- 滚动时无需重新渲染所有内容

---

**2. 字形缓存**

**原理**：预先将常用字符渲染为 GPU 纹理

**实现**：
```
启动时：
- 缓存 ASCII 可打印字符（94 个）
- 缓存 CJK 常用汉字（3500 个）

运行时：
- 使用缓存的纹理直接绘制
- 未缓存的字符临时渲染并加入缓存
```

**内存估算**：
```
单个字符纹理：32x32 像素 x 4 字节(RGBA) = 4KB
3500 个汉字：3500 x 4KB = 14MB
```

---

**3. 增量渲染**

**原理**：仅重绘变化的部分

**实现**：
```
按键事件发生 → 标记脏区域（Dirty Region）
              → 仅重绘脏区域及其周边
              → 其他区域使用缓存的渲染结果
```

**脏区域定义**：
```
当前字符位置 ± 3 个字符
```

---

### 8.2 计算性能

#### 统计计算优化

**WPM 计算**：
- 使用滑动窗口（10 秒）而非全量计算
- 仅在按键事件时触发计算，而非每帧计算

**薄弱按键分析**：
- 使用 `HashMap` 而非遍历，时间复杂度 O(n) → O(1)
- 仅在会话结束时计算一次

#### 多线程设计

**线程分配**：
```
主线程：GPUI 渲染
后台线程 1：引擎状态更新 + 统计计算
后台线程 2：数据库写入（异步）
```

**线程通信**：
- 使用 `std::sync::mpsc` 进行事件传递
- 使用 `Arc<Mutex<T>>` 共享只读状态

---

### 8.3 存储性能

#### 数据库优化

**写入策略**：
- 批量写入：会话结束后一次性写入所有数据
- 异步写入：不阻塞 UI 线程

**查询优化**：
```sql
-- 为常用查询创建索引
CREATE INDEX idx_lesson_id ON sessions(lesson_id);
CREATE INDEX idx_timestamp ON sessions(timestamp);
```

**缓存策略**：
- 用户的最佳成绩缓存在内存中
- 课程元数据缓存 1 小时

---

## 九、可扩展性设计

### 9.1 插件系统（未来）

#### 课程插件

**机制**：
- 用户可创建自定义课程包
- 课程包以 `.keyzen-pack` 格式分发
- 一键导入到 `lessons/custom/` 目录

**课程包结构**：
```
my-course-pack.keyzen-pack (实际是 .zip 文件)
├── manifest.ron          # 元数据
├── lessons/
│   ├── 01_intro.ron
│   ├── 02_practice.ron
│   └── 03_advanced.ron
└── assets/
    └── cover.png         # 封面图
```

---

#### 主题插件

**机制**：
- 社区贡献主题文件（`.ron` 格式）
- 放入 `themes/` 目录自动识别

---

### 9.2 多语言支持

#### 当前支持

- 中文（含拼音）
- 英文
- 代码（Rust, Python, JavaScript）

#### 扩展路径

**添加新语言的步骤**：
1. 在 `lessons/[language]/` 创建目录
2. 编写 RON 格式的课程文件
3. 更新 `keyzen_data` 的语言识别逻辑
4. （可选）针对该语言的特殊排版逻辑

**示例：添加日语支持**：
```
lessons/japanese/
├── hiragana/
│   ├── 01_a_line.ron     # あ行练习
│   └── 02_ka_line.ron    # か行练习
└── katakana/
    └── 01_basics.ron
```

---

### 9.3 社区内容

#### 课程分享平台（未来）

**愿景**：
- 用户可上传自定义课程到社区
- 其他用户可下载并导入
- 评分和评论系统

**技术实现**：
- 静态网站托管在 GitHub Pages
- 课程文件存储在 GitHub Releases
- 使用 GitHub API 拉取课程列表

---

## 十、实施路线图

### Phase 1: MVP（2-3 周）

#### 目标
完成最小可用产品，验证核心体验。

#### 功能清单

| 模块 | 功能 | 优先级 |
|------|------|--------|
| **keyzen_core** | 类型定义、事件定义 | P0 |
| **keyzen_data** | RON 格式课程加载 | P0 |
| **keyzen_engine** | 基础打字逻辑（Forgiving 模式） | P0 |
| **keyzen_ui** | GPUI 基础界面（核心练习区 + 统计栏） | P0 |
| **课程内容** | 英文基础 5 课 + Rust 代码 3 课 | P0 |
| **统计功能** | 实时 WPM、准确率计算 | P0 |

#### 验收标准
- [ ] 用户可以选择课程并开始练习
- [ ] 输入反馈流畅（< 16ms 延迟）
- [ ] 完成后显示统计结果
- [ ] 界面符合"极简、禅意"设计理念

---

### Phase 2: 增强（2 周）

#### 目标
完善功能，提升用户体验。

#### 功能清单

| 模块 | 功能 | 优先级 |
|------|------|--------|
| **keyzen_persistence** | SQLite 集成，保存历史记录 | P0 |
| **keyzen_engine** | 中文拼音输入支持 | P0 |
| **keyzen_ui** | 主题系统、设置界面 | P1 |
| **课程内容** | 中文拼音 10 课 + 特殊符号 5 课 | P0 |
| **统计功能** | 薄弱按键分析、历史记录查看 | P1 |
| **开发工具** | 热重载课程文件（debug 模式） | P2 |

#### 验收标准
- [ ] 用户可以查看练习历史和进步曲线
- [ ] 中文拼音输入流畅且准确
- [ ] 可切换深色/浅色主题
- [ ] 薄弱按键分析准确

---

### Phase 3: 完善（1-2 周）

#### 目标
优化体验，准备发布。

#### 功能清单

| 模块 | 功能 | 优先级 |
|------|------|--------|
| **keyzen_ui** | 多种练习模式（Timed/Endless） | P1 |
| **统计功能** | 个性化推荐算法 | P2 |
| **音效系统** | 可选的按键音效 | P2 |
| **跨平台** | macOS/Linux/Windows 打包 | P0 |
| **文档** | 用户手册、开发者文档 | P1 |
| **课程内容** | 总计 50+ 课程 | P1 |

#### 验收标准
- [ ] 支持 3 大操作系统
- [ ] 课程推荐准确且有帮助
- [ ] 用户文档完整易懂
- [ ] 性能达标（120 FPS + < 100MB 内存）

---

### Phase 4: 社区化（未来）

#### 愿景
- 课程插件市场
- 多人竞速模式
- 全球排行榜
- 移动端适配（iOS/Android）

---

## 附录

### A. 技术栈总结

| 层级 | 技术选型 | 理由 |
|------|----------|------|
| **语言** | Rust | 性能、安全性、跨平台 |
| **UI 框架** | GPUI | 高性能、原生体验、Zed 同源 |
| **数据格式** | RON | Rust 原生、类型安全 |
| **数据库** | SQLite | 轻量、本地优先 |
| **序列化** | serde | Rust 生态标准 |
| **拼音处理** | pinyin crate | 成熟的中文拼音库 |

---

### B. 设计原则清单

✅ **DO（应该做）**
- 极简界面，移除一切非必要元素
- 优先保证 120 FPS 渲染性能
- 使用柔和的颜色和动画
- 数据与 UI 完全分离
- 支持键盘快捷键

❌ **DON'T（不应该做）**
- 使用刺眼的红色错误提示
- 在渲染线程进行复杂计算
- 硬编码课程内容
- 在 UI 层实现业务逻辑
- 阻塞用户操作

---

### C. 术语表

| 术语 | 定义 |
|------|------|
| **WPM** | Words Per Minute，每分钟字数（÷5） |
| **CPM** | Characters Per Minute，每分钟字符数 |
| **心流** | 完全沉浸于任务的专注状态 |
| **涟漪效果** | 按键后的圆形扩散动画 |
| **虚拟渲染** | 仅渲染可见区域的技术 |
| **脏区域** | 需要重新绘制的屏幕区域 |
| **快照** | 状态的轻量级只读副本 |

---

## 总结

本设计文档定义了 Keyzen 的完整产品愿景、技术架构和实施计划。核心设计理念可以概括为：

> **以禅意之心，打造极致流畅的打字练习体验**

通过 Rust + GPUI 的技术栈，我们将实现：
1. **120 FPS** 的丝滑渲染
2. **零干扰**的极简界面
3. **多语言**的包容支持
4. **数据驱动**的科学进步

---

**下一步**：根据 Phase 1 路线图，开始项目初始化和核心模块开发。
